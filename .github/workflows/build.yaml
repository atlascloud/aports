---
name: build packages

'on': push

jobs:
  build:
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        release: [edge]  # TODO 3.12, 3.11, etc

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 5
      - uses: actions/cache@v2
        with:
          path: |
            apkcache/
            distfiles/
            .ccache/
          # packages/
          key: ${{ matrix.release }}
      - run: |
          # pwd ; find * ; env
          mkdir -p apkcache/ distfiles/ packages/ .ccache/ .abuild/
          sudo chown -R 1000:1000 .
          make build
        env:
          RELEASE: ${{ matrix.release }}
          PACKAGER: ${{ secrets.PACKAGER }}
          PACKAGER_PRIVKEY: ${{ secrets.PACKAGER_PRIVKEY }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          JOBS: ${{ secrets.JOBS }}
          REPODEST: /home/build/packages/${{ matrix.release }}
      # if we are merging into the master branch, upload the built package
      - if: github.ref == 'refs/heads/master'
        run: |
          set -x
          cd packages/${{ matrix.release }}/main/x86_64
          for apk in $(find . -type f -name '*.apk') ; do
            echo "Uploading $apk to packages.atlascloud.xyz"
            curl -sSL \
              -H 'Authorization: Bearer ${{ secrets.PACKAGES_TOKEN }}' \
              -F "architecture=x86_64;type=text/plain" \
              -F "package=@${apk}" \
              https://packages.atlascloud.xyz/api/o/atlascloud/r/${{ matrix.release }}/v/edge
          done
